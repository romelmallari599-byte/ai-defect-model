<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Romel S.A - AI Structural Assessment</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-gold: #c5a47e;
            --primary-dark: #3a3a3a;
            --header-start: #1e1e1e;
            --header-end: #333333;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --bg-light: #fdfaf5;
            --text-dark: #343a40;
            --text-light: #6c757d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; overflow-x: hidden; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--header-start);
            color: var(--text-dark);
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--header-start);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        #loading-overlay.fade-out {
            opacity: 0;
        }
        #loading-overlay .header-logo-container {
            width: 80px;
            height: 80px;
        }
        #loading-overlay h1 {
            font-size: 2.5rem; color: var(--primary-gold); margin-top: 1.5rem;
            background: linear-gradient(90deg, #d4af37, #ffd700, #d4af37);
            -webkit-background-clip: text; background-clip: text; color: transparent; animation: shine 5s infinite linear;
        }

        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; position: relative; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { font-size: 1.25rem; color: var(--header-start); margin-bottom: 1rem; }
        .modal-content p { margin-bottom: 1.5rem; color: #555; line-height: 1.6; font-size: 0.9rem; }
        .modal-button { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; background: var(--primary-gold); color: white; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: #333;
        }

        .app-container {
            position: relative; z-index: 1; width: 100%; max-width: 800px;
            margin: 1rem auto; background: var(--bg-light); min-height: calc(100vh - 2rem);
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden; display: flex; flex-direction: column;
        }
        header { background: linear-gradient(135deg, var(--header-start) 0%, var(--header-end) 100%); color: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--primary-gold); display: flex; justify-content: space-between; align-items: center; }
        .header-content { display: flex; align-items: center; gap: 15px; }
        .header-logo-container { width: 50px; height: 50px; perspective: 1000px; }
        .pyramid-loader { position: relative; width: 100%; height: 100%; transform-style: preserve-3d; animation: rotatePyramid 20s linear infinite; }
        .pyramid-face { position: absolute; width: 100%; height: 100%; border-style: solid; border-width: 25px 0 25px 43.3px; border-color: transparent transparent transparent rgba(197, 164, 126, 0.7); transform-origin: 50% 50%; }
        .pyramid-face:nth-child(1) { transform: rotateY(0deg) translateZ(14.4px); }
        .pyramid-face:nth-child(2) { transform: rotateY(120deg) translateZ(14.4px); }
        .pyramid-face:nth-child(3) { transform: rotateY(240deg) translateZ(14.4px); }
        .pyramid-face.base { border-width: 43.3px 25px 0 25px; border-color: rgba(197, 164, 126, 0.6) transparent transparent transparent; transform: rotateX(-90deg) translateY(-25px); bottom: 0; }
        @keyframes rotatePyramid { from { transform: rotateY(0deg) rotateX(20deg); } to { transform: rotateY(360deg) rotateX(20deg); } }
        .header-text { text-align: left; }
        .header-text h1 { font-size: 1.8rem; font-weight: 700; color: var(--primary-gold); margin: 0; position: relative; display: inline-block; background: linear-gradient(90deg, #d4af37, #ffd700, #d4af37); -webkit-background-clip: text; background-clip: text; color: transparent; animation: shine 5s infinite linear; }
        @keyframes shine { 0% { background-position: -200px; } 100% { background-position: 200px; } }
        .header-text p { opacity: 0.9; font-size: 1rem; margin: 0; font-style: italic; }
        
        .nav-tabs { display: flex; background: #fff; border-bottom: 1px solid #dee2e6; overflow-x: auto; position: relative; }
        #progress-bar-container { position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: #e9ecef; }
        #progress-bar { width: 25%; height: 100%; background-color: var(--primary-gold); transition: all 0.5s ease-in-out; }
        .nav-tab { flex: 1; padding: 15px 10px; background: none; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-light); transition: all 0.3s ease; white-space: nowrap; text-align: center; z-index: 1; }
        .nav-tab.active { color: var(--primary-gold); }

        .tab-content { display: none; padding: 25px; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-dark); }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 1rem; }

        .upload-area { text-align: center; border: 3px dashed #ccc; border-radius: 20px; padding: 40px 25px; cursor: pointer; transition: all 0.3s ease; background: #fff; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-gold); background: #fffef5; }
        .upload-area h3 { font-size: 1.1rem; color: var(--text-dark); }
        .btn { padding: 15px 25px; border: none; border-radius: 30px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; border-radius: 20px; }
        .btn:disabled { cursor: wait; background: #ccc; opacity: 0.7; }
        .btn-primary { background: linear-gradient(45deg, var(--primary-gold), #b89251); color: var(--header-end); }
        .btn-primary:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3); }
        
        .analysis-container { background: white; border-radius: 20px; padding: 25px; margin-top: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
        #preview-container { position: relative; }
        #cancel-upload { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.5); color: white; border: none;
            cursor: pointer; padding: 5px 10px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 600;
        }
        #image-preview { width: 100%; max-height: 300px; object-fit: contain; border-radius: 15px; margin-bottom: 20px; }
        
        .results-summary-container { display: flex; align-items: center; justify-content: center; gap: 2rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .safety-score-container { text-align: center; flex-shrink: 0; }
        .score-circle { width: 150px; height: 150px; position: relative; background: conic-gradient(from 135deg, var(--danger) 0deg, var(--warning) 135deg, var(--success) 270deg); }
        #score-arrow { width: 2px; height: 45%; background: var(--header-start); position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1); transform: rotate(135deg); }
        #score-arrow::after { content: ''; position: absolute; top: -10px; left: -4px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid var(--header-start); }
        .score-inner-circle { width: 120px; height: 120px; background: white; }
        .score-value { font-size: 2.2rem; } .score-label { font-size: 0.7rem; }
        .safety-score-container, .score-circle, .score-inner-circle { display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }
        .score-inner-circle { flex-direction: column; }
        
        .score-legend { flex-grow: 1; min-width: 250px; }
        .legend-item { display: flex; align-items: flex-start; margin-bottom: 1rem; }
        .legend-color-box { width: 20px; height: 20px; border-radius: 5px; margin-right: 12px; flex-shrink: 0; margin-top: 4px; }
        .legend-text h5 { font-size: 1rem; margin: 0; color: var(--text-dark); }
        .legend-text span { font-size: 0.8rem; font-weight: 600; color: var(--text-light); }
        .legend-text p { font-size: 0.85rem; color: var(--text-light); margin-top: 2px; line-height: 1.4; }

        .severity-banner { text-align: center; padding: 20px; border-radius: 15px; margin-top: 20px; font-size: 1rem; border-width: 2px; border-style: solid; }
        .severity-good { background: #e6f9f0; border-color: var(--success); color: #1e6a43; }
        .severity-repairable { background: #fff8e6; border-color: var(--warning); color: #8a6d3b; }
        .severity-dangerous { background: #fbe9ea; border-color: var(--danger); color: #a94442; }

        .detail-card { background: #ffffff; padding: 20px; border-radius: 15px; border-left: 5px solid var(--primary-gold); margin-top: 1.5rem; position: relative; }
        .detail-card h4 { margin-bottom: 0.5rem; color: var(--text-dark); }
        .detail-card ul { padding-left: 1.2rem; }
        .detail-card .learn-more { font-size: 0.8rem; color: var(--primary-gold); text-decoration: underline; cursor: pointer; font-weight: 600; }

        .emergency-card { background: #fbe9ea; border: 2px solid var(--danger); display: none; padding: 20px; border-radius: 15px; margin-bottom: 1.5rem; text-align: center;}
        .emergency-card.visible {
            display: block;
            animation: pulse-danger 1.5s infinite;
        }

        @keyframes pulse-danger {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .btn:active:not(:disabled), .nav-tab:active, .history-item:active, #chatbot-button:active, .modal-button:active, #capture-btn:active {
            transform: scale(0.98);
            filter: brightness(0.95);
        }

        #chatbot-button { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary-gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--header-end); font-size: 1.8rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 999; transition: transform 0.2s ease; }
        #chat-container { position: fixed; bottom: 90px; right: 20px; width: 90%; max-width: 320px; max-height: 450px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; flex-direction: column; overflow: hidden; transform: translateY(20px) scale(0.95); opacity: 0; transition: all 0.3s ease-in-out; z-index: 998; }
        #chat-container.show { transform: translateY(0) scale(1); opacity: 1; display: flex; }
        #chat-container header { background: var(--header-end); color: var(--primary-gold); padding: 12px; text-align: center; font-weight: 600; position: relative; }
        #close-chat { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: white; cursor: pointer; font-size: 1.2rem; font-weight: bold; }
        #chat-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.9rem; display: flex; flex-direction: column; }
        #chat-messages div { margin-bottom: 10px; line-height: 1.4; padding: 8px 12px; border-radius: 18px; max-width: 80%; }
        #chat-messages div.user { background: #eee; align-self: flex-end; margin-left: auto; }
        #chat-messages div.bot { background: var(--primary-gold); color: white; align-self: flex-start; }
        .typing-indicator { align-self: flex-start; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin: 0 2px; animation: bounce 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        #chat-input-container { display: flex; border-top: 1px solid #ddd; }
        #chat-input-container input { flex: 1; border: none; padding: 12px; font-size: 0.9rem; }
        #chat-input-container input:focus { outline: none; }
        #chat-input-container button { background: var(--primary-gold); color: white; border: none; padding: 0 15px; cursor: pointer; font-size: 1.2rem; }

        #camera-view { display: none; padding: 20px; background: black; border-radius: 15px; }
        #camera-feed { width: 100%; border-radius: 10px; }
        .camera-controls { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .camera-controls button { width: auto; padding: 10px 20px; }
        #capture-btn { width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; }

        .contact-card { background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .contact-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        .contact-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(45deg, var(--primary-gold), #b89251); color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600; margin-bottom: 1rem; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .contact-card h3 { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        .contact-card p { color: var(--text-light); margin-top: 0.25rem; font-size: 1rem; }
        .contact-details { margin-top: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .contact-details a { display: inline-flex; align-items: center; justify-content: center; gap: 12px; padding: 12px 20px; border-radius: 50px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; }
        .contact-details .email-btn { background-color: var(--primary-dark); color: white; }
        .contact-details .email-btn:hover { background-color: #000; }
        .contact-details .call-btn { background-color: var(--success); color: white; }
        .contact-details .call-btn:hover { background-color: #218838; }
        .contact-details svg { width: 20px; height: 20px; }

        #history-list { max-height: 300px; overflow-y: auto; padding-right: 10px; }
        .history-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; border: 1px solid #eee; }
        .history-item:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .history-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .history-item-info h5 { margin: 0; font-size: 1rem; color: var(--text-dark); }
        .history-item-info p { margin: 0; font-size: 0.8rem; color: var(--text-light); }
        #history-detail-modal .modal-content { text-align: left; max-width: 600px; }
        #history-detail-modal .modal-content .form-group input { padding: 8px; }
        #history-detail-modal .modal-content .history-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 1.5rem; }
        #history-detail-modal img { width: 100%; border-radius: 10px; margin-bottom: 1rem; }
        
        #close-graph-btn {
            position: absolute; top: 15px; right: 15px;
            width: 30px; height: 30px;
            border: none; border-radius: 50%;
            background: #e0e0e0; color: #555;
            font-weight: bold; font-size: 1rem;
            cursor: pointer; display: none;
            transition: all 0.2s ease;
        }
        #close-graph-btn:hover { background: #d4d4d4; }

        .cost-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .cost-table th, .cost-table td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .cost-table th { background-color: #f8f9fa; font-size: 0.9rem; }
        .cost-table input { width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .cost-table input[type="number"] { width: 60px; text-align: center;}
        .cost-table input:read-only { background: #f0f0f0; cursor: not-allowed; }
        .cost-table .delete-item-btn { background: none; border: none; color: var(--danger); font-weight: bold; cursor: pointer; font-size: 1.2rem; }
        .cost-tool-actions { display: flex; justify-content: flex-end; margin-top: 1rem; }

        #graph-warning { text-align: center; padding: 10px; border-radius: 10px; margin-top: 1rem; font-weight: 600; }
        .graph-controls { display: flex; gap: 10px; align-items: center; }
        .graph-controls select { flex-grow: 1; }
        .graph-controls .btn { width: auto; padding: 10px 15px; font-size: 0.9rem; }

        #nscp-details-modal .modal-content { text-align: left; line-height: 1.7; }
        #nscp-details-modal .modal-content h4 { color: var(--primary-dark); }
        #nscp-details-modal .modal-content ul { padding-left: 20px; }
        
        #preview-buttons { display: flex; gap: 1rem; margin-top: 1rem; }

        @media (max-width: 830px) {
            body { padding: 0; }
            .app-container { margin: 0; border-radius: 0; min-height: 100vh; }
            header h1 { font-size: 1.8rem; }
        }
        @media (max-width: 600px) {
            .results-summary-container { flex-direction: column; gap: 1.5rem; }
            #preview-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="header-logo-container">
            <div class="pyramid-loader">
                <div class="pyramid-face"></div> <div class="pyramid-face"></div> <div class="pyramid-face"></div> <div class="pyramid-face base"></div>
            </div>
        </div>
        <h1>Romel S.A</h1>
    </div>

    <audio id="audio-intro" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASwBEAEgAqwC8AAAAAQAAAAAEgdmLgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMPVCAAAAAD4FTlAAAAA4lVg3QBVfVhXPcrDPwMhAAAAAEluZm8AAAAPAAAAAwAAAbAAQU1ULTIuMC41VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-"></audio>
    <audio id="audio-click" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASwBEAEgAqwC8AAAAAQAAAAAEgdmLgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMPVCAAAAAD4FTlAAAAA4lVg3QBVfVhXPcrDPwMhAAAAAEluZm8AAAAPAAAAAwAAAbAAQU1ULTIuMC41VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-"></audio>
    <audio id="audio-success" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASwBEAEgAqwC8AAAAAQAAAAAEgdmLgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMPVCAAAAAD4FTlAAAAA4lVg3QBVfVhXPcrDPwMhAAAAAEluZm8AAAAPAAAAAwAAAbAAQU1ULTIuMC41VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-"></audio>

    <canvas id="particle-canvas"></canvas>
    <canvas id="photo-canvas" style="display:none;"></canvas>

    <div class="app-container">
        <header>
            <div class="header-content">
                <div class="header-logo-container">
                    <div class="pyramid-loader">
                        <div class="pyramid-face"></div> <div class="pyramid-face"></div> <div class="pyramid-face"></div> <div class="pyramid-face base"></div>
                    </div>
                </div>
                <div class="header-text">
                    <h1 data-lang-key="app_title">Romel S.A</h1>
                    <p data-lang-key="company_name">Pyramidia P.</p>
                </div>
            </div>
            <select id="lang-switcher" onchange="switchLang(this.value)" style="padding:5px; border-radius:10px; border:1px solid var(--primary-gold); background: #fff;">
                <option value="en">English</option>
                <option value="fil">Filipino</option>
            </select>
        </header>

        <div id="api-key-container" style="display: none;">
            <input type="password" id="api-key-input" placeholder="Enter Your New Gemini API Key Here">
            <button id="api-key-btn" onclick="setApiKey()">Set Key</button>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('upload')" data-lang-key="tab_upload">1. Upload</button>
            <button class="nav-tab" id="analysis-tab" onclick="showTab('analysis')" data-lang-key="tab_analysis">2. Analysis</button>
            <button class="nav-tab" id="tools-tab" onclick="showTab('tools')" data-lang-key="tab_tools">3. Tools</button>
            <button class="nav-tab" id="contact-tab" onclick="showTab('contact')" data-lang-key="tab_contact">4. Contact</button>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
        </nav>

        <main id="upload" class="tab-content active">
            <h2 style="text-align:center; color:var(--text-dark)" data-lang-key="upload_title">Start New Assessment</h2>
            <p style="text-align: center; color: var(--text-light); margin: 0.5rem 0 1.5rem;" data-lang-key="upload_subtitle">Upload a clear photo for analysis.</p>
            
             <div class="form-group">
                <label for="crack-identifier" data-lang-key="crack_id_label">Crack Identifier / Name</label>
                <input type="text" id="crack-identifier" data-lang-key="crack_id_placeholder" placeholder="e.g., Living Room Wall">
            </div>
            
            <div id="upload-options">
                <div id="upload-area" class="upload-area"><h3 data-lang-key="upload_box">Click or Drag to Upload</h3></div>
                <input type="file" id="file-input" style="display:none" accept="image/*" onchange="handleFileSelect(event)">
            </div>

            <div id="camera-view">
                <video id="camera-feed" playsinline autoplay></video>
                <div class="camera-controls">
                    <button class="btn" onclick="closeCamera()" data-lang-key="cancel_btn">Cancel</button>
                    <button id="capture-btn" class="btn btn-primary" onclick="capturePhoto()">ðŸ“¸</button>
                </div>
            </div>

            <div id="preview-container" class="analysis-container" style="display:none">
                <button id="cancel-upload" onclick="resetApp()">Cancel</button>
                <h3 style="text-align:center; margin-bottom:1rem;" data-lang-key="preview_title">Photo Preview</h3>
                <img id="image-preview" style="width:100%; border-radius:15px;"/>
                <div id="preview-buttons">
                    <button id="change-photo-btn" class="btn" onclick="document.getElementById('file-input').click()" style="background: var(--text-light); color: white;">Change Photo</button>
                    <button id="start-analysis-btn" class="btn btn-primary" onclick="startAnalysis()" data-lang-key="start_analysis_btn">Start AI Analysis</button>
                </div>
            </div>
             <div class="detail-card">
                <h4 data-lang-key="guidelines_title">Photo Guidelines for Best Results:</h4>
                <ul style="list-style: 'âœ” '; padding-left: 1.2rem; margin-top: 0.5rem; color: var(--text-light); line-height: 1.8; font-size: 0.9rem;">
                    <li data-lang-key="guideline_1">Use good, even lighting.</li>
                    <li data-lang-key="guideline_2">Focus on the crack.</li>
                    <li data-lang-key="guideline_3">Include a coin (like a 1-Piso coin) beside the crack for scale. This helps the AI estimate the size (e.g., 2mm).</li>
                    <li data-lang-key="guideline_4">Clean the surface first.</li>
                </ul>
            </div>
        </main>

        <section id="analysis" class="tab-content">
            <div id="no-analysis-view" style="text-align:center; padding:50px 20px;">
                <h2 style="color:var(--text-dark); margin-bottom: 0.5rem;">No Analysis Data</h2>
                <p style="color:var(--text-light);">Please go to the "Upload" tab, select a photo, and click "Start AI Analysis" to see the results here.</p>
            </div>
            <div id="loading-view" style="display: none; text-align:center; padding:50px">
                <svg style="margin: auto; height: 3rem; width: 3rem; color: var(--primary-gold);" class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg>
                <h2 style="font-size: 1.25rem; margin-top: 1.5rem;" data-lang-key="analyzing">Analyzing Image...</h2>
            </div>
            <div id="results-view" style="display:none">
                <h2 style="text-align:center; color:var(--text-dark)" data-lang-key="analysis_complete">Analysis Complete</h2>
                
                <div class="results-summary-container">
                    <div class="safety-score-container">
                        <div class="score-circle">
                            <div id="score-arrow"></div>
                            <div class="score-inner-circle">
                                <div id="safety-score-value" class="score-value">--</div>
                                <div class="score-label" data-lang-key="safety_score">Safety Score</div>
                            </div>
                        </div>
                    </div>
                    <div class="score-legend">
                        <div class="legend-item">
                            <div class="legend-color-box" style="background-color: var(--success);"></div>
                            <div class="legend-text">
                                <h5><span data-lang-key="legend_safe_range">81-100</span> - <span data-lang-key="legend_safe_title">Safe</span></h5>
                                <p data-lang-key="legend_safe_desc">No significant structural risks found.</p>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background-color: var(--warning);"></div>
                            <div class="legend-text">
                                <h5><span data-lang-key="legend_moderate_range">41-80</span> - <span data-lang-key="legend_moderate_title">Moderate</span></h5>
                                <p data-lang-key="legend_moderate_desc">Requires repairs and professional consultation.</p>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color-box" style="background-color: var(--danger);"></div>
                            <div class="legend-text">
                                <h5><span data-lang-key="legend_dangerous_range">0-40</span> - <span data-lang-key="legend_dangerous_title">Dangerous</span></h5>
                                <p data-lang-key="legend_dangerous_desc">Immediate professional intervention is critical.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="severity-banner" class="severity-banner"><h3 id="severity-text"></h3><p id="severity-description"></p></div>
                <div class="detail-card"><h4 data-lang-key="detected_issues">âœ¨ AI Vision Analysis:</h4><ul id="issues-list"></ul></div>
                <div class="detail-card">
                    <h4 data-lang-key="nscp_ref">NSCP 2015 Reference:</h4>
                    <p id="nscp-ref" style="margin-top: 0.5rem;"></p>
                    <span class="learn-more" onclick="showNscpModal()">Learn more about NSCP 2015</span>
                </div>
                <div class="detail-card"><h4 data-lang-key="recommendations_title">Repair Recommendations:</h4><ul id="recommendations-list"></ul></div>
                
                <div class="detail-card">
                    <div class="form-group">
                        <label for="user-notes" data-lang-key="notes_label">Optional Notes</label>
                        <textarea id="user-notes" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" data-lang-key="notes_placeholder" placeholder="e.g., Noticed after recent heavy rain..."></textarea>
                    </div>
                    <button id="save-history-btn" class="btn btn-primary" onclick="saveAnalysisToHistory()" data-lang-key="save_history_btn">Save to History</button>
                </div>
                
                <button id="download-report-btn" class="btn btn-primary" onclick="generatePDF()" data-lang-key="download_report_btn" style="margin-top: 20px; background: var(--primary-dark); color: white;">Download PDF Report</button>
            </div>
        </section>

        <section id="tools" class="tab-content">
            <div class="detail-card" style="margin-top:0;">
                <h3 data-lang-key="history_title">Assessment History</h3>
                <div id="history-list">
                    <p data-lang-key="no_history">No history saved yet.</p>
                </div>
            </div>

            <div class="detail-card">
                <button id="close-graph-btn" onclick="closeGraph()">X</button>
                <h3 data-lang-key="graph_title">Crack Growth Tracker</h3>
                <div class="form-group">
                    <label for="graph-crack-selector" data-lang-key="select_crack_label">Select a Crack to Graph:</label>
                    <div class="graph-controls">
                        <select id="graph-crack-selector" class="form-group input" onchange="updateGraph()" style="width:100%; padding: 10px; border-radius: 8px;"></select>
                        <button class="btn btn-sm" onclick="renameCrackGroup()">Rename</button>
                    </div>
                </div>
                <canvas id="crack-chart"></canvas>
                <div id="graph-warning" style="display:none;"></div>
            </div>

            <div class="detail-card">
                <h3 data-lang-key="cost_tool_title">Cost Estimation Tool</h3>
                <p style="font-size:0.9rem; color:var(--text-light);" data-lang-key="cost_tool_subtitle">Estimate the cost of basic repair materials.</p>
                <table class="cost-table">
                    <thead>
                        <tr>
                            <th data-lang-key="cost_item">Item</th>
                            <th data-lang-key="cost_qty">Quantity</th>
                            <th data-lang-key="cost_price">Price (PHP)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cost-table-body">
                    </tbody>
                </table>
                <div class="cost-tool-actions">
                     <button class="btn btn-sm" onclick="addCostItemRow()">Add Item</button>
                </div>
                <p id="total-cost" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-gold); text-align: right; margin-top: 1rem;">Total: â‚±0.00</p>
                <p style="font-size:0.8rem; color:var(--text-light); margin-top:1rem; text-align:right;" data-lang-key="cost_disclaimer">Disclaimer: This is only an estimate. Actual costs may vary.</p>
            </div>
        </section>

        <section id="contact" class="tab-content">
            <h2 id="contact-page-title" style="font-size: 1.5rem; color: var(--text-dark); text-align: center; margin-bottom: 1.5rem;" data-lang-key="contact_title">Consult a Licensed Engineer</h2>
            <div id="emergency-card" class="emergency-card"><h3 data-lang-key="emergency_title">Immediate Action Required</h3><p data-lang-key="emergency_text">Your assessment indicates a DANGEROUS condition. Contact a licensed professional immediately.</p></div>
            
            <div class="contact-card">
                <div class="contact-avatar">RSM</div>
                <h3>Engr. Romel S. Mallari</h3>
                <p id="professional-title">Licensed Structural Engineer</p>
                <div class="contact-details">
                    <a href="mailto:romelmallari599@gmail.com" class="email-btn btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M1.5 8.67v8.58a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3V8.67l-8.928 5.493a3 3 0 0 1-3.144 0L1.5 8.67Z"/><path d="M22.5 6.908V6.75a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3v.158l9.714 5.978a1.5 1.5 0 0 0 1.572 0L22.5 6.908Z"/></svg>
                        <span id="email-btn-text" data-lang-key="email_btn">Email Engineer</span>
                    </a>
                    <a href="tel:09614410460" class="call-btn btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M1.5 4.5a3 3 0 0 1 3-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 0 1-.694 1.955l-1.293.97c-.135.101-.164.279-.087.431l4.108 7.293a.414.414 0 0 0 .431.087l.97-1.293a1.875 1.875 0 0 1 1.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.819V19.5a3 3 0 0 1-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5Z" clip-rule="evenodd"/></svg>
                        <span data-lang-key="call_btn">Call Now</span>
                    </a>
                </div>
            </div>

             <div class="detail-card" style="margin-top: 2rem;">
                <h4 data-lang-key="disclaimer_title">Important Disclaimer</h4>
                <p style="font-size:0.9rem; margin-top: 0.5rem;" data-lang-key="disclaimer_text">This AI is for preliminary analysis only. A licensed engineer is required for a definitive safety assessment.</p>
            </div>
        </section>

        <div id="chatbot-button" onclick="toggleChat(event)">âœ¨</div>
        <div id="chat-container">
            <header data-lang-key="assistant_header">Pyramidia AI Assistant<span id="close-chat" onclick="toggleChat(event)">X</span></header>
            <div id="chat-messages" class="messages"></div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" data-lang-key="chat_placeholder" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()">âž¤</button>
            </div>
        </div>
    </div>
    
    <div id="modal" class="modal-overlay"><div class="modal-content"><h3 id="modal-title"></h3><p id="modal-text"></p><button class="modal-button" onclick="hideModal()">OK</button></div></div>
    
    <div id="history-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideHistoryDetailModal()">âœ–</button>
            <h3 data-lang-key="history_detail_title">Analysis Details</h3>
            <img id="history-detail-img" src="" alt="Crack Image">
            <div id="history-detail-content"></div>
            <div class="history-buttons">
                 <button class="modal-button" style="background: var(--text-light);" onclick="hideHistoryDetailModal()">Close</button>
                 <button id="history-edit-btn" class="modal-button" onclick="toggleHistoryEdit(this, 0)">Edit</button>
            </div>
        </div>
    </div>

    <div id="nscp-details-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideNscpModal()">âœ–</button>
            <h3>About the NSCP 2015</h3>
            <p>The <strong>National Structural Code of the Philippines (NSCP), 2015 Edition</strong>, is the primary standard followed by civil and structural engineers in the country. It ensures that buildings and structures are designed and built to be safe against natural disasters like earthquakes and typhoons.</p>
            <h4>Key Sections on Concrete Evaluation:</h4>
            <ul>
                <li><strong>Chapter 4, Section 407 - Reinforcement Details:</strong> Specifies rules for steel bar placement, which is crucial for crack control. Improper spacing can lead to cracks under load.</li>
                <li><strong>Chapter 4, Section 420 - Strength Evaluation of Existing Structures:</strong> Outlines the official procedures for engineers to assess the safety and integrity of an existing building, including when and how to perform load tests if structural integrity is in doubt due to cracks or other damage.</li>
                <li><strong>Chapter 4, Section 424 - Concrete Serviceability:</strong> This section discusses crack control in detail, defining the maximum allowable crack widths for different exposure conditions (e.g., interior vs. exterior) to prevent moisture intrusion and corrosion of steel reinforcement.</li>
            </ul>
            <p><strong>Important:</strong> An on-site assessment by a licensed engineer is required to determine which specific sections of the code apply to your situation.</p>
            <button class="modal-button" onclick="hideNscpModal()">Got it</button>
        </div>
    </div>

    <div id="report-template" style="position: absolute; left: -9999px; top: 0; width: 800px; padding: 40px; background: white; font-family: 'Poppins', sans-serif; color: #333; display: flex; flex-direction: column; min-height: 1122px; justify-content: space-between;">
    </div>

<script>
    // --- DOM Element Constants ---
    const uploadArea = document.getElementById('upload-area');
    const uploadOptions = document.getElementById('upload-options');
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('preview-container');
    const imagePreview = document.getElementById('image-preview');
    const startAnalysisBtn = document.getElementById('start-analysis-btn');
    const loadingView = document.getElementById('loading-view');
    const resultsView = document.getElementById('results-view');
    const noAnalysisView = document.getElementById('no-analysis-view');
    const issuesList = document.getElementById('issues-list');
    const nscpRef = document.getElementById('nscp-ref');
    const recommendationsList = document.getElementById('recommendations-list');
    const scoreArrow = document.getElementById('score-arrow');
    const safetyScoreValue = document.getElementById('safety-score-value');
    const severityBanner = document.getElementById('severity-banner');
    const emergencyCard = document.getElementById('emergency-card');
    const langSwitcher = document.getElementById('lang-switcher');
    const modal = document.getElementById('modal');
    const cameraView = document.getElementById('camera-view');
    const cameraFeed = document.getElementById('camera-feed');
    const photoCanvas = document.getElementById('photo-canvas');
    const historyDetailModal = document.getElementById('history-detail-modal');
    const nscpDetailsModal = document.getElementById('nscp-details-modal');
    
    // --- App State ---
    let geminiApiKey = 'AIzaSyBOcpNJ1t9NX8jVk2CrtX54x_cK-wJrcwE'; 
    let currentImageBase64 = null;
    let currentAnalysisResult = null;
    let cameraStream = null;
    let crackChart = null;
    let userHasInteracted = false;

    // --- API & Rate Limiting ---
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=";
    const apiRequestTimestamps = [];
    const RATE_LIMIT_COUNT = 1;
    const RATE_LIMIT_WINDOW_MS = 1 * 60 * 1000; // 1 minutes

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        setTimeout(() => {
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
        }, 3000); 

        document.body.addEventListener('click', handleFirstInteraction, { once: true });
        document.body.addEventListener('touchstart', handleFirstInteraction, { once: true });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
        });
        uploadArea.addEventListener('drop', handleDrop, false);
        uploadArea.addEventListener('click', () => fileInput.click());
        
        runParticleAnimation();
        loadHistory();
        switchLang('en');
    });

    function handleFirstInteraction() {
        if (!userHasInteracted) {
            userHasInteracted = true;
            playSound('audio-intro');
        }
    }


    // --- API & Rate Limiting Logic ---
    function isRateLimited() {
        const now = Date.now();
        while (apiRequestTimestamps.length > 0 && apiRequestTimestamps[0] < now - RATE_LIMIT_WINDOW_MS) { apiRequestTimestamps.shift(); }
        if (apiRequestTimestamps.length >= RATE_LIMIT_COUNT) {
            console.warn("Rate limit exceeded.");
            const timeLeft = Math.ceil((apiRequestTimestamps[0] + RATE_LIMIT_WINDOW_MS - now) / 60000);
            showModal("Usage Limit Reached", `You have made too many requests. Please try again in about ${timeLeft} minutes.`);
            return true;
        }
        return false;
    }

    function recordApiCall() { apiRequestTimestamps.push(Date.now()); }
    function setApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) {
            geminiApiKey = key;
            showModal("API Key Set", "Your API key has been set for this session.");
        } else {
            showModal("Invalid Key", "Please enter a valid Gemini API key.");
        }
    }

    async function analyzeImageWithGemini(base64ImageData) {
        if (isRateLimited()) return null;
        
        const prompt = `
            You are an expert AI for structural and architectural assessment in the Philippines. Analyze the provided image of a defect in a structure.
            Your response MUST be a clean JSON object, without any "json" markdown wrapper.
            The JSON object must have these exact keys: "description", "safety_score", "severity", "crack_width_mm", "nscp_reference", "recommendations", "estimated_materials", "consultation_needed".
            - "description": An array of strings describing the visual characteristics (e.g., "Hairline crack noted", "Paint peeling due to moisture").
            - "safety_score": An integer between 0 (dangerous) and 100 (safe). Structural issues should have lower scores than superficial ones.
            - "severity": A string: "Hairline", "Moderate", or "Severe".
            - "crack_width_mm": Estimated numerical width in millimeters. Provide 0 if not applicable (e.g., for paint issues).
            - "nscp_reference": A relevant section of the National Structural Code of the Philippines (NSCP 2015) or a note that it's an architectural issue if applicable.
            - "recommendations": An array of strings with actionable repair recommendations.
            - "estimated_materials": An array of objects. Each object must have "item" (string), "estimated_php_price" (string, e.g., "500-700"), and "suggested_quantity" (integer). The quantity must be an educated guess based on the visual extent of the damage. A small crack might need quantity 1, a long/severe one might need 2 or 3.
            - "consultation_needed": A string, must be either "Engineer" or "Architect". If the issue is structural (crack in a beam, column, slab) choose "Engineer". If it's superficial (paint peeling, plaster finish crack) choose "Architect". If in doubt, default to "Engineer".
            If the image is unclear, provide a low safety score and recommend uploading a better image.
        `;

        const payload = { contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64ImageData } } ] }] };

        try {
            recordApiCall();
            const response = await fetch(GEMINI_API_URL + geminiApiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API Error: ${errorBody.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            const textResponse = data.candidates[0].content.parts[0].text;
            const cleanedJsonString = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(cleanedJsonString);

        } catch (error) {
            console.error("Error analyzing image:", error);
            showModal("Analysis Error", `There was a problem contacting the AI. Details: ${error.message}`);
            return null;
        }
    }
    
    async function getGeminiChatbotResponse(userMessage) {
        const prompt = `You are Pyramidia, a friendly and helpful AI assistant specializing in structural engineering and construction in the Philippines. Answer the user's questions clearly and concisely. If the question is outside your expertise, politely say so. Current analysis context: ${JSON.stringify(currentAnalysisResult)}`;
        
        const payload = { contents: [{ parts: [ { text: prompt }, { text: userMessage } ] }] };

        try {
            const response = await fetch(GEMINI_API_URL + geminiApiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("API request failed");
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("Chatbot API error:", error);
            return "I'm sorry, I'm having trouble connecting right now. Please try again later.";
        }
    }

    // --- Core App Logic ---
    function showTab(tabName) {
        document.querySelectorAll('.tab-content, .nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');
        const progressBar = document.getElementById('progress-bar');
        if (tabName === 'upload') progressBar.style.width = '25%';
        if (tabName === 'analysis') progressBar.style.width = '50%';
        if (tabName === 'tools') progressBar.style.width = '75%';
        if (tabName === 'contact') progressBar.style.width = '100%';
    }
    
    function resetApp() {
        closeCamera();
        previewContainer.style.display = 'none';
        uploadOptions.style.display = 'block';
        fileInput.value = '';
        currentImageBase64 = null;
        currentAnalysisResult = null;
        document.getElementById('crack-identifier').value = '';
        document.getElementById('user-notes').value = '';
        showTab('upload');
        issuesList.innerHTML = '';
        nscpRef.textContent = '';
        recommendationsList.innerHTML = '';
        safetyScoreValue.textContent = '--';
        scoreArrow.style.transform = 'rotate(135deg)';
        document.getElementById('cost-table-body').innerHTML = '';
        calculateTotalCost();
        emergencyCard.classList.remove('visible');
        
        // Reset analysis view to initial state
        noAnalysisView.style.display = 'block';
        loadingView.style.display = 'none';
        resultsView.style.display = 'none';
    }

    function handleFileSelect(event) { if (event.target.files.length) processFile(event.target.files[0]); }
    function handleDrop(e) { if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]); }
    
    function processFile(file) {
        if (!file.type.startsWith('image/')) { showModal("Invalid File", "Please upload a valid image file."); return; }
        const reader = new FileReader();
        reader.onload = e => displayPreview(e.target.result);
        reader.readAsDataURL(file);
    }

    function displayPreview(dataUrl) {
        imagePreview.src = dataUrl;
        currentImageBase64 = dataUrl.split(',')[1];
        previewContainer.style.display = 'block';
        uploadOptions.style.display = 'none';
        cameraView.style.display = 'none';
    }

    async function startAnalysis() {
        playSound('audio-click');
        if (!geminiApiKey) { showModal("API Key Required", "The hardcoded Gemini API key is missing or invalid."); return; }
        if (!currentImageBase64) { showModal("No Image", "Please upload an image first."); return; }

        startAnalysisBtn.disabled = true;
        const originalBtnText = startAnalysisBtn.textContent;
        startAnalysisBtn.innerHTML = `<svg class="animate-spin" style="height: 1.2rem; width: 1.2rem;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" opacity="0.75"></path></svg> ${translations[langSwitcher.value].analyzing}`;
        
        showTab('analysis');
        noAnalysisView.style.display = 'none';
        loadingView.style.display = 'block';
        resultsView.style.display = 'none';

        const result = await analyzeImageWithGemini(currentImageBase64);
        
        loadingView.style.display = 'none';
        
        if (!result || result.safety_score == null) {
            noAnalysisView.style.display = 'block';
            showTab('upload'); // Go back to upload if analysis failed
        } else {
            currentAnalysisResult = result;
            populateResults(result);
            resultsView.style.display = 'block';
            playSound('audio-success');
        }
        
        startAnalysisBtn.disabled = false;
        startAnalysisBtn.innerHTML = originalBtnText;
    }
    
    function populateResults(result) {
        const { description, safety_score, nscp_reference, recommendations, estimated_materials, consultation_needed } = result;
        const visualSeverity = determineSeverityFromScore(safety_score);
        issuesList.innerHTML = description.map(line => `<li>${line}</li>`).join('');
        nscpRef.textContent = nscp_reference;
        recommendationsList.innerHTML = recommendations.map(line => `<li>${line}</li>`).join('');
        animateValue("safety-score-value", 0, safety_score, 1500);
        const rotation = 135 + (safety_score / 100) * 270;
        setTimeout(() => { scoreArrow.style.transform = `rotate(${rotation}deg)`; }, 100);
        severityBanner.className = `severity-banner severity-${visualSeverity.toLowerCase()}`;
        
        if (visualSeverity === 'Dangerous') {
            emergencyCard.classList.add('visible');
        } else {
            emergencyCard.classList.remove('visible');
        }
        
        const professionalTitle = document.getElementById('professional-title');
        const contactPageTitle = document.getElementById('contact-page-title');
        const emailBtnText = document.getElementById('email-btn-text');
        
        if (consultation_needed === 'Architect') {
            professionalTitle.textContent = 'Licensed Architect';
            contactPageTitle.textContent = 'Consult a Licensed Architect';
            emailBtnText.textContent = 'Email Architect';
        } else { 
            professionalTitle.textContent = 'Licensed Structural Engineer';
            contactPageTitle.textContent = 'Consult a Licensed Engineer';
            emailBtnText.textContent = 'Email Engineer';
        }

        severityBanner.dataset.severity = visualSeverity;
        
        if (estimated_materials) {
            updateCostEstimator(estimated_materials);
        }

        switchLang(langSwitcher.value);
        if (visualSeverity === 'Dangerous') {
            setTimeout(() => showTab('contact'), 2500);
        }
    }

    function determineSeverityFromScore(score) {
        if (score == null) return "Repairable";
        if (score > 80) return "Good";
        if (score > 40) return "Repairable";
        return "Dangerous";
    }

    // --- History Functions ---
    function getHistory() { return JSON.parse(localStorage.getItem('crackHistory') || '[]'); }
    function saveHistory(history) { localStorage.setItem('crackHistory', JSON.stringify(history)); }

    function saveAnalysisToHistory() {
        playSound('audio-click');
        if (!currentAnalysisResult) { showModal("Error", "No analysis data to save."); return; }
        const history = getHistory();
        const crackIdentifier = document.getElementById('crack-identifier').value.trim() || 'Untitled';
        const userNotes = document.getElementById('user-notes').value.trim();
        const newRecord = { id: Date.now(), name: crackIdentifier, date: new Date().toISOString(), image: currentImageBase64, notes: userNotes, ...currentAnalysisResult };
        history.push(newRecord);
        saveHistory(history);
        showModal("Success", `Analysis for "${crackIdentifier}" has been saved to history.`);
        loadHistory();
    }

    function loadHistory() {
        const history = getHistory();
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        if (history.length === 0) {
            historyList.innerHTML = `<p data-lang-key="no_history">${translations[langSwitcher.value]?.no_history || 'No history saved yet.'}</p>`;
        } else {
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            history.forEach(record => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.onclick = () => showHistoryDetailModal(record.id);
                item.innerHTML = `
                    <img src="data:image/jpeg;base64,${record.image}" alt="${record.name}">
                    <div class="history-item-info">
                        <h5>${record.name}</h5>
                        <p>${new Date(record.date).toLocaleString()} - ${record.severity} (${record.crack_width_mm}mm)</p>
                    </div>
                `;
                historyList.appendChild(item);
            });
        }
        populateGraphDropdown();
        updateGraph();
    }
    
    function showHistoryDetailModal(id) {
        const record = getHistory().find(r => r.id === id);
        if (!record) return;

        const contentDiv = document.getElementById('history-detail-content');
        contentDiv.innerHTML = `
            <div class="form-group">
                <label>Identifier / Name</label>
                <span data-field="name">${record.name}</span>
            </div>
            <div class="form-group">
                <label>Crack Width (mm)</label>
                <span data-field="crack_width_mm">${record.crack_width_mm}</span>
            </div>
             <p><strong>Date:</strong> ${new Date(record.date).toLocaleString()}</p>
             <p><strong>Severity:</strong> ${record.severity}</p>
             <p><strong>Notes:</strong></p>
             <p style="background: #f8f9fa; padding: 10px; border-radius: 8px;">${record.notes || 'No notes provided.'}</p>
        `;

        document.getElementById('history-detail-img').src = `data:image/jpeg;base64,${record.image}`;
        document.getElementById('history-edit-btn').setAttribute('onclick', `toggleHistoryEdit(this, ${id})`);
        document.getElementById('history-edit-btn').textContent = 'Edit';
        historyDetailModal.classList.add('active');
    }

    function toggleHistoryEdit(button, id) {
        const contentDiv = document.getElementById('history-detail-content');
        const isEditMode = button.textContent === 'Save';

        if (isEditMode) {
            const nameInput = contentDiv.querySelector('input[data-field="name"]');
            const widthInput = contentDiv.querySelector('input[data-field="crack_width_mm"]');
            saveHistoryChanges(id, nameInput.value, widthInput.value);
            button.textContent = 'Edit';
            
            // Revert back to spans
            nameInput.parentElement.innerHTML = `<label>Identifier / Name</label><span data-field="name">${nameInput.value}</span>`;
            widthInput.parentElement.innerHTML = `<label>Crack Width (mm)</label><span data-field="crack_width_mm">${widthInput.value}</span>`;

        } else { // Switch to edit mode
            button.textContent = 'Save';
            const nameSpan = contentDiv.querySelector('span[data-field="name"]');
            const widthSpan = contentDiv.querySelector('span[data-field="crack_width_mm"]');
            
            nameSpan.parentElement.innerHTML = `<label>Identifier / Name</label><input type="text" class="form-group input" data-field="name" value="${nameSpan.textContent}">`;
            widthSpan.parentElement.innerHTML = `<label>Crack Width (mm)</label><input type="number" class="form-group input" data-field="crack_width_mm" value="${widthSpan.textContent}">`;
        }
    }

    function saveHistoryChanges(id, newName, newWidth) {
        let history = getHistory();
        const recordIndex = history.findIndex(r => r.id === id);
        if (recordIndex > -1) {
            history[recordIndex].name = newName;
            history[recordIndex].crack_width_mm = parseFloat(newWidth) || 0;
            saveHistory(history);
            loadHistory();
            showModal("Success", "History item has been updated.");
        }
    }

    function hideHistoryDetailModal() { historyDetailModal.classList.remove('active'); }

    // --- Graph Functions ---
    function populateGraphDropdown() {
        const history = getHistory();
        const uniqueNames = [...new Set(history.map(item => item.name))];
        const selector = document.getElementById('graph-crack-selector');
        const currentVal = selector.value;
        selector.innerHTML = '<option value="">-- Select --</option>';
        uniqueNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            selector.appendChild(option);
        });
        if (uniqueNames.includes(currentVal)) {
            selector.value = currentVal;
        }
    }
    
    function renameCrackGroup() {
        const selector = document.getElementById('graph-crack-selector');
        const oldName = selector.value;
        if (!oldName) {
            showModal("No Selection", "Please select a crack group to rename.");
            return;
        }

        const newName = prompt(`Enter a new name for the group "${oldName}":`, oldName);
        if (!newName || newName.trim() === '' || newName === oldName) {
            return; // User cancelled or entered same/empty name
        }

        let history = getHistory();
        history.forEach(record => {
            if (record.name === oldName) {
                record.name = newName.trim();
            }
        });
        saveHistory(history);
        loadHistory();
        selector.value = newName.trim(); // Keep the new name selected
        showModal("Success", `Group "${oldName}" was renamed to "${newName.trim()}".`);
    }

    function updateGraph() {
        const selector = document.getElementById('graph-crack-selector');
        const closeBtn = document.getElementById('close-graph-btn');
        const selectedCrackName = selector.value;
        if (!selectedCrackName) { closeGraph(); return; };
        const history = getHistory();
        const crackData = history.filter(r => r.name === selectedCrackName).sort((a,b) => new Date(a.date) - new Date(b.date));
        const labels = crackData.map(r => new Date(r.date).toLocaleDateString());
        const dataPoints = crackData.map(r => r.crack_width_mm);
        let pointBackgroundColor = 'green';
        if (crackData.length > 1) {
            const last = crackData[crackData.length - 1];
            const secondLast = crackData[crackData.length - 2];
            const widthDiff = last.crack_width_mm - secondLast.crack_width_mm;
            if (widthDiff > 2) pointBackgroundColor = 'red';
            else if (widthDiff > 0) pointBackgroundColor = 'orange';
        }
        const ctx = document.getElementById('crack-chart').getContext('2d');
        if (crackChart) crackChart.destroy();
        crackChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Crack Width (mm) for ${selectedCrackName}`,
                    data: dataPoints,
                    borderColor: 'rgba(197, 164, 126, 1)',
                    backgroundColor: 'rgba(197, 164, 126, 0.2)',
                    pointBackgroundColor: pointBackgroundColor,
                    pointRadius: 5,
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Crack Width (mm)' } } } }
        });
        closeBtn.style.display = 'block';
        const warningDiv = document.getElementById('graph-warning');
        warningDiv.style.display = 'none';
        if(crackData.length > 1) {
            const last = crackData[crackData.length - 1];
            const first = crackData[0];
            const timeDiffMs = new Date(last.date) - new Date(first.date);
            const timeDiffMonths = timeDiffMs / (1000 * 60 * 60 * 24 * 30.44);
            if (timeDiffMonths <= 1 && (last.crack_width_mm - first.crack_width_mm) > 5) {
                warningDiv.style.display = 'block';
                warningDiv.style.backgroundColor = 'var(--danger)';
                warningDiv.style.color = 'white';
                warningDiv.textContent = translations[langSwitcher.value].graph_warning;
            }
        }
    }

    function closeGraph() {
        if (crackChart) { crackChart.destroy(); crackChart = null; }
        document.getElementById('close-graph-btn').style.display = 'none';
        document.getElementById('graph-crack-selector').value = '';
        document.getElementById('graph-warning').style.display = 'none';
    }

    // --- Cost Estimator Functions ---
    function updateCostEstimator(materials) {
        const tableBody = document.getElementById('cost-table-body');
        tableBody.innerHTML = ''; 
        if (!materials || materials.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No specific materials recommended for this issue.</td></tr>`;
            calculateTotalCost();
            return;
        }
        materials.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${item.item}" readonly></td>
                <td><input type="number" value="${item.suggested_quantity || 1}" min="0" readonly></td>
                <td><input type="text" value="${item.estimated_php_price}" readonly></td>
                <td></td>
            `;
            tableBody.appendChild(row);
        });
        calculateTotalCost(); 
    }

    function addCostItemRow() {
        const tableBody = document.getElementById('cost-table-body');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" placeholder="Material Name" oninput="calculateTotalCost()"></td>
            <td><input type="number" value="1" min="0" oninput="calculateTotalCost()"></td>
            <td><input type="text" placeholder="e.g., 500-700" oninput="calculateTotalCost()"></td>
            <td><button class="delete-item-btn" onclick="this.closest('tr').remove(); calculateTotalCost();">âœ–</button></td>
        `;
        tableBody.appendChild(row);
    }
    
    function calculateTotalCost() {
        let minTotal = 0, maxTotal = 0;
        const rows = document.querySelectorAll('#cost-table-body tr');
        rows.forEach(row => {
            const quantityInput = row.querySelector('input[type="number"]');
            const priceInput = row.querySelector('td:nth-child(3) input[type="text"]'); // <-- FIXED SELECTOR
            if (!quantityInput || !priceInput) return;

            const quantity = parseInt(quantityInput.value) || 0;
            const priceStr = String(priceInput.value); 
            let minPrice, maxPrice;
            if (priceStr.includes('-')) { [minPrice, maxPrice] = priceStr.split('-').map(p => parseFloat(p.replace(/,/g, ''))); } 
            else { minPrice = maxPrice = parseFloat(priceStr.replace(/,/g, '')); }
            if(!isNaN(minPrice)) minTotal += quantity * minPrice;
            if(!isNaN(maxPrice)) maxTotal += quantity * maxPrice;
        });
        const totalCostEl = document.getElementById('total-cost');
        if (minTotal === 0 && maxTotal === 0) {
             totalCostEl.textContent = `Total: â‚±0.00`;
        } else if (minTotal === maxTotal) { 
            totalCostEl.textContent = `Total: â‚±${minTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; 
        } else { 
            totalCostEl.textContent = `Total: â‚±${minTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} - â‚±${maxTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; 
        }
    }


    // --- Camera Functions ---
    async function openCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showModal("Camera Not Supported", "Your browser does not support camera access."); return; }
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
            cameraFeed.srcObject = cameraStream;
            cameraView.style.display = 'block';
            uploadOptions.style.display = 'none';
        } catch (err) { console.error("Camera Error:", err); showModal("Camera Error", "Could not access the camera. It might not be available on this device, or permission was denied."); }
    }
    function closeCamera() {
        if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); }
        cameraView.style.display = 'none';
        uploadOptions.style.display = 'block';
    }
    function capturePhoto() {
        const context = photoCanvas.getContext('2d');
        photoCanvas.width = cameraFeed.videoWidth;
        photoCanvas.height = cameraFeed.videoHeight;
        context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);
        displayPreview(photoCanvas.toDataURL('image/jpeg'));
        closeCamera();
    }
    
    function playSound(soundId) {
        const sound = document.getElementById(soundId);
        if (!sound) return;
        sound.currentTime = 0;
        const playPromise = sound.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error(`Could not play sound '${soundId}':`, error);
            });
        }
    }

    // --- UI & Utility Functions ---
    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id); let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }
    async function generatePDF() { 
        const reportBtn = document.getElementById('download-report-btn');
        const originalBtnText = reportBtn.textContent;
        reportBtn.disabled = true; 
        reportBtn.textContent = translations[langSwitcher.value].generating_pdf;
        try {
            const { jsPDF } = window.jspdf;
            const reportTemplate = document.getElementById('report-template');
            reportTemplate.innerHTML = `
                <div style="padding: 20px; border: 1px solid #eee; border-radius: 15px; display: flex; flex-direction: column; height: 100%;">
                    <div style="text-align: center; border-bottom: 2px solid #c5a47e; padding-bottom: 20px;">
                        <h1 style="font-size: 32px; color: #1e1e1e; margin: 0;">Romel S.A</h1>
                        <p style="font-size: 16px; margin: 5px 0 0; color: #555;">Structural Integrity Assessment Report</p>
                    </div>
                    <div style="margin-top: 25px; flex-grow: 1;">
                        <h2 style="font-size: 20px;">Analysis Summary</h2>
                        <table style="width: 100%; margin-top: 15px; font-size: 14px; border-collapse: collapse;">
                            <tr><td style="padding: 8px; background-color: #f9f9f9; width: 30%;"><strong>Date:</strong></td><td style="padding: 8px;">${new Date(currentAnalysisResult.date || Date.now()).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td></tr>
                            <tr><td style="padding: 8px; background-color: #f9f9f9;"><strong>Severity:</strong></td><td style="padding: 8px; font-weight: bold;">${currentAnalysisResult.severity}</td></tr>
                            <tr><td style="padding: 8px; background-color: #f9f9f9;"><strong>Safety Score:</strong></td><td style="padding: 8px; font-weight: bold;">${currentAnalysisResult.safety_score} / 100</td></tr>
                        </table>
                         <h2 style="font-size: 20px; margin-top: 25px;">Assessed Image</h2>
                         <img src="${'data:image/jpeg;base64,' + currentImageBase64}" style="max-width: 100%; margin-top: 15px; border-radius: 8px; border: 1px solid #ccc;"/>
                        <h2 style="font-size: 20px; margin-top: 25px;">AI Detected Issues</h2>
                        <div style="margin-top: 15px; font-size: 14px; line-height: 1.6;"><ul>${currentAnalysisResult.description.map(d => `<li>${d}</li>`).join('')}</ul></div>
                        <h2 style="font-size: 20px; margin-top: 25px;">Repair Recommendations</h2>
                        <div style="margin-top: 15px; font-size: 14px; line-height: 1.6;"><ul>${currentAnalysisResult.recommendations.map(r => `<li>${r}</li>`).join('')}</ul></div>
                    </div>
                    <div style="border-top: 2px solid #eee; padding-top: 15px; font-size: 12px; margin-top: auto;">
                        <p style="font-style: italic;"><strong>Disclaimer:</strong> This is a preliminary AI analysis. A licensed engineer is required for a definitive safety assessment.</p>
                    </div>
                </div>`;
            const canvas = await html2canvas(reportTemplate, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            const { width: pdfWidth } = pdf.internal.pageSize;
            pdf.addImage(imgData, 'PNG', 20, 20, pdfWidth - 40, (pdfWidth - 40) / (canvas.width / canvas.height));
            pdf.save(`Romel-SA-Report-${Date.now()}.pdf`);
        } catch (error) {
            console.error("PDF Error:", error);
            showModal("PDF Error", "Could not generate the PDF.");
        } finally {
            reportBtn.disabled = false;
            reportBtn.textContent = originalBtnText;
        }
     }
    function showModal(title, text) { modal.querySelector('#modal-title').textContent = title; modal.querySelector('#modal-text').textContent = text; modal.classList.add('active'); }
    function hideModal() { modal.classList.remove('active'); }
    function showNscpModal() { nscpDetailsModal.classList.add('active'); }
    function hideNscpModal() { nscpDetailsModal.classList.remove('active'); }
    function runParticleAnimation() { /* Particle animation logic can be added here if needed */ }
    function toggleChat(event) { if (event) event.stopPropagation(); document.getElementById('chat-container').classList.toggle('show'); }
    
    async function sendMessage() {
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const userMessage = chatInput.value.trim();

        if (userMessage === '') return;

        const userDiv = document.createElement('div');
        userDiv.className = 'user';
        userDiv.textContent = userMessage;
        chatMessages.appendChild(userDiv);
        chatInput.value = '';

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'bot typing-indicator';
        typingIndicator.innerHTML = '<span></span><span></span><span></span>';
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        const botResponse = await getGeminiChatbotResponse(userMessage);
        typingIndicator.remove();

        const botDiv = document.createElement('div');
        botDiv.className = 'bot';
        botDiv.textContent = botResponse;
        chatMessages.appendChild(botDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    // --- Localization ---
    const translations = {
        en: {"app_title":"Romel S.A","company_name":"Pyramidia P.","tab_upload":"1. Upload","tab_analysis":"2. Analysis","tab_tools":"3. Tools","tab_contact":"4. Contact","upload_title":"Start New Assessment","upload_subtitle":"Upload a clear photo for analysis.","upload_box":"Click or Drag to Upload","camera_btn":"Use Camera","cancel_btn":"Cancel","preview_title":"Photo Preview","start_analysis_btn":"Start AI Analysis","analyzing":"Analyzing...","analysis_complete":"Analysis Complete","safety_score":"Safety Score","detected_issues":"âœ¨ AI Vision Analysis:","nscp_ref":"NSCP 2015 Reference:","recommendations_title":"Repair Recommendations:","download_report_btn":"Download PDF Report","generating_pdf":"Generating...","contact_title":"Consult a Licensed Engineer","emergency_title":"Immediate Action Required","emergency_text":"Your assessment indicates a DANGEROUS condition. Contact a licensed professional immediately.","email_btn":"Email Engineer","call_btn":"Call Now","assistant_header":"Pyramidia AI Assistant","chat_placeholder":"Ask a question...","disclaimer_title":"Important Disclaimer","disclaimer_text":"This AI is for preliminary analysis only. A licensed engineer is required for a definitive safety assessment.","guidelines_title":"Photo Guidelines for Best Results:","guideline_1":"Use good, even lighting.","guideline_2":"Focus on the crack.","guideline_3":"Include a coin (like a 1-Piso coin) beside the crack for scale. This helps the AI estimate the size (e.g., 2mm).","guideline_4":"Clean the surface first.","severity_good_title":"Condition: Good","severity_good_desc":"No significant issues detected.","severity_repairable_title":"Condition: Repairable","severity_repairable_desc":"Minor to moderate damage detected.","severity_dangerous_title":"Condition: Dangerous","severity_dangerous_desc":"Significant damage detected. Immediate action required.","legend_safe_range":"81-100","legend_safe_title":"Safe","legend_safe_desc":"No significant structural risks found.","legend_moderate_range":"41-80","legend_moderate_title":"Moderate","legend_moderate_desc":"Requires repairs and professional consultation.","legend_dangerous_range":"0-40","legend_dangerous_title":"Dangerous","legend_dangerous_desc":"Immediate professional intervention is critical.", "crack_id_label": "Crack Identifier / Name", "crack_id_placeholder": "e.g., Living Room Wall", "notes_label": "Optional Notes", "notes_placeholder": "e.g., Noticed after recent heavy rain...", "save_history_btn": "Save to History", "history_title": "Assessment History", "no_history": "No history saved yet.", "graph_title": "Crack Growth Tracker", "select_crack_label": "Select a Crack to Graph:", "graph_warning": "Crack size increased significantly. Consult a licensed civil engineer.", "cost_tool_title": "Cost Estimation Tool", "cost_tool_subtitle": "Estimate the cost of basic repair materials.", "cost_item": "Item", "cost_qty": "Quantity", "cost_price": "Price (PHP)", "cost_disclaimer": "Disclaimer: This is only an estimate. Actual costs may vary.", "history_detail_title": "Analysis Details", "history_detail_date": "Date:", "history_detail_severity": "Severity:", "history_detail_width": "Crack Width:", "history_detail_notes": "Notes:"},
        fil: {"app_title":"Romel S.A","company_name":"Pyramidia P.","tab_upload":"1. Mag-upload","tab_analysis":"2. Pagsusuri","tab_tools":"3. Mga Gamit","tab_contact":"4. Kontakin","upload_title":"Magsimula ng Pagsusuri","upload_subtitle":"Mag-upload ng malinaw na litrato.","upload_box":"Pindutin o i-Drag para Mag-upload","camera_btn":"Gamitin ang Camera","cancel_btn":"Kanselahin","preview_title":"Silipin ang Litrato","start_analysis_btn":"Simulan ang AI Analysis","analyzing":"Sinusuri...","analysis_complete":"Kumpleto ang Pagsusuri","safety_score":"Marka ng Kaligtasan","detected_issues":"âœ¨ Pagsusuri ng AI Vision:","nscp_ref":"Sanggunian sa NSCP 2015:","recommendations_title":"Mga Rekomendasyon sa Pag-aayos:","download_report_btn":"I-download ang PDF Report","generating_pdf":"Ginagawa...","contact_title":"Kumonsulta sa Inhinyero","emergency_title":"Kailangan ng Agarang Aksyon","emergency_text":"Ang iyong pagsusuri ay DELIKADO. Kontakin agad ang isang lisensyadong propesyonal.","email_btn":"I-email ang Inhinyero","call_btn":"Tawagan Na","assistant_header":"Katulong na Pyramidia AI","chat_placeholder":"Magtanong...","disclaimer_title":"Mahalagang Paalala","disclaimer_text":"Ang AI na ito ay para lamang sa paunang pagsusuri. Kailangan pa rin ng isang lisensyadong inhinyero para sa tiyak na pagsusuri sa kaligtasan.","guidelines_title":"Mga Gabay sa Pagkuha ng Litrato:","guideline_1":"Gumamit ng maayos at pantay na ilaw.","guideline_2":"I-focus ang camera sa bitak.","guideline_3":"Maglagay ng barya (tulad ng 1-Piso) sa tabi ng bitak para may basehan ng sukat. Makakatulong ito sa AI na tantyahin ang laki (hal. 2mm).","guideline_4":"Linisin muna ang ibabaw ng pader.","severity_good_title":"Kondisyon: Maayos","severity_good_desc":"Walang nakitang malubhang problema.","severity_repairable_title":"Kondisyon: Kailangan Ayusin","severity_repairable_desc":"May kaunti o katamtamang sira.","severity_dangerous_title":"Kondisyon: Delikado","severity_dangerous_desc":"Malubhang sira. Kailangan ng agarang aksyon.","legend_safe_range":"81-100","legend_safe_title":"Ligtas","legend_safe_desc":"Walang nakitang malaking panganib sa istruktura.","legend_moderate_range":"41-80","legend_moderate_title":"Katamtaman","legend_moderate_desc":"Nangangailangan ng pagkumpuni at konsultasyon.","legend_dangerous_range":"0-40","legend_dangerous_title":"Delikado","legend_dangerous_desc":"Kritikal ang agarang aksyon mula sa propesyonal.", "crack_id_label": "Pangalan ng Bitak", "crack_id_placeholder": "hal., Pader sa Sala", "notes_label": "Opsyonal na Tala", "notes_placeholder": "hal., Napansin pagkatapos ng malakas na ulan...", "save_history_btn": "I-save sa History", "history_title": "History ng Pagsusuri", "no_history": "Wala pang naka-save na history.", "graph_title": "Tracker ng Paglaki ng Bitak", "select_crack_label": "Pumili ng Bitak para sa Graph:", "graph_warning": "Malaki ang itinaas ng sukat ng bitak. Kumonsulta sa isang lisensyadong civil engineer.", "cost_tool_title": "Tool sa Pagtantya ng Gastos", "cost_tool_subtitle": "Tantyahin ang gastos para sa mga pangunahing materyales sa pag-aayos.", "cost_item": "Materyales", "cost_qty": "Bilang", "cost_price": "Presyo (PHP)", "cost_disclaimer": "Paalala: Ito ay isang pagtatantya lamang. Ang aktwal na gastos ay maaaring mag-iba.", "history_detail_title": "Detalye ng Pagsusuri", "history_detail_date": "Petsa:", "history_detail_severity": "Lala:", "history_detail_width": "Lapad ng Bitak:", "history_detail_notes": "Mga Tala:"}
    };
    
    function switchLang(lang) {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            const translation = translations[lang]?.[key];
            if (translation) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.placeholder = translation; } 
                else { el.innerText = translation; }
            }
        });

        const banner = document.getElementById('severity-banner');
        const severity = banner.dataset.severity;
        if (severity) {
            document.getElementById('severity-text').textContent = translations[lang][`severity_${severity.toLowerCase()}_title`];
            document.getElementById('severity-description').textContent = translations[lang][`severity_${severity.toLowerCase()}_desc`];
        }
        
        const warningDiv = document.getElementById('graph-warning');
        if (warningDiv.style.display !== 'none') {
            warningDiv.textContent = translations[lang].graph_warning;
        }
    }
</script>
</body>
</html>